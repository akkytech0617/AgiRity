# ライブラリバージョンアップ手順書

このドキュメントはライブラリの依存関係をアップグレードする際の標準手順を定義します。

Snyk等のセキュリティツールが自動作成したPRや、手動でのバージョンアップ作業に適用してください。

---

## 概要

ライブラリのバージョンアップは以下のリスクを伴います：

- **Breaking Changes**: API変更によるコンパイルエラー・実行時エラー
- **非互換性**: 他の依存関係との競合
- **機能退行**: 動作変更による予期しない挙動

これらのリスクを軽減するため、本手順に従って検証を実施してください。

---

## 確認フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                    ライブラリバージョンアップ                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. PR/変更内容の確認                                            │
│    - 変更されるライブラリとバージョン                            │
│    - Breaking Changesの有無                                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. 影響範囲の調査                                               │
│    - プロジェクト内での使用箇所特定                              │
│    - Breaking Changesが影響するか確認                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. 検証環境での確認                                             │
│    - 依存関係インストール                                       │
│    - ビルド確認                                                 │
│    - Lint確認                                                   │
│    - テスト実行                                                 │
│    - 動作確認                                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. マージ判断                                                   │
│    - 全項目パス → マージ可                                      │
│    - 失敗あり → 修正対応または却下                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 詳細手順

### 1. PR/変更内容の確認

#### 1.1 変更対象の把握

PRまたは変更差分から以下を確認：

```bash
# PRのファイル変更を確認
gh pr view <PR番号> --json files

# または直接差分を確認
git diff main...<ブランチ名> -- package.json package-lock.json
```

確認項目：

- 変更されるライブラリ名
- 現在のバージョン → 新バージョン
- メジャー/マイナー/パッチのどれか

#### 1.2 Breaking Changesの確認

ライブラリのリリースノート・CHANGELOGを確認：

| 確認先          | URL例                                                             |
| --------------- | ----------------------------------------------------------------- |
| GitHub Releases | `https://github.com/<owner>/<repo>/releases`                      |
| CHANGELOG.md    | リポジトリ内のCHANGELOG.md                                        |
| npm             | `https://www.npmjs.com/package/<package-name>?activeTab=versions` |

特に注意すべきキーワード：

- `BREAKING CHANGE`
- `DEPRECATED`
- `Renamed`
- `Removed`

---

### 2. 影響範囲の調査

#### 2.1 使用箇所の特定

```bash
# ライブラリのimport箇所を検索
grep -r "from ['\"]<ライブラリ名>['\"]" --include="*.ts" --include="*.tsx" src/

# 特定のシンボル（関数・クラス・コンポーネント）を検索
grep -r "<シンボル名>" --include="*.ts" --include="*.tsx" src/
```

#### 2.2 Breaking Changesの影響判定

| Breaking Changeの内容       | 確認方法                     |
| --------------------------- | ---------------------------- |
| 関数/コンポーネント名の変更 | 旧名称でgrep検索             |
| 引数/プロパティの変更       | 該当関数の呼び出し箇所を確認 |
| 型定義の変更                | TypeScriptビルドで検出       |
| デフォルト値の変更          | 動作確認で検出               |

---

### 3. 検証環境での確認

#### 3.1 ブランチのチェックアウト

```bash
# PRブランチを取得
git fetch origin <ブランチ名>
git checkout <ブランチ名>
```

#### 3.2 依存関係のインストール

```bash
npm ci
```

確認項目：

- [ ] インストール成功
- [ ] 脆弱性警告の確認（`found X vulnerabilities`）
- [ ] peer dependency警告の確認

#### 3.3 ビルド確認

```bash
# TypeScript型チェック
npm run type-check

# 本番ビルド
npm run build
```

確認項目：

- [ ] 型エラーなし
- [ ] ビルド成功

#### 3.4 Lint確認

```bash
npm run lint
```

確認項目：

- [ ] エラー0件
- [ ] 新規警告がないか（既存警告は許容）

#### 3.5 テスト実行

```bash
# ユニットテスト
npm test

# E2Eテスト
npm run test:e2e:dev
```

確認項目：

- [ ] 全テストパス
- [ ] 新たな失敗なし

#### 3.6 動作確認

```bash
npm run dev
```

確認項目：

- [ ] 開発サーバー起動成功
- [ ] アプリケーション正常動作
- [ ] 変更ライブラリを使用している画面の目視確認

---

### 4. マージ判断

#### 4.1 判断基準

| 結果         | 判断                      |
| ------------ | ------------------------- |
| 全項目パス   | マージ可                  |
| ビルドエラー | Breaking Change対応が必要 |
| テスト失敗   | 原因調査・修正が必要      |
| 動作不具合   | 原因調査・修正が必要      |

#### 4.2 Breaking Change対応が必要な場合

1. PRブランチ上で修正をコミット
2. 再度検証を実施
3. 全項目パスを確認してからマージ

---

## チェックリスト

PRレビュー時に使用するチェックリスト：

```markdown
## ライブラリアップグレード検証

### 対象

- ライブラリ名:
- バージョン: X.X.X → Y.Y.Y
- Breaking Changes: あり / なし

### 検証結果

- [ ] 依存関係インストール成功
- [ ] TypeScriptビルド成功
- [ ] Lint エラーなし
- [ ] 全テストパス
- [ ] 開発サーバー起動確認
- [ ] 動作確認完了

### 判定

- [ ] マージ可
- [ ] 修正が必要（理由: ）
```

---

## Snyk PRの対応

Snykが自動作成するPRは以下の形式です：

- ブランチ名: `snyk-upgrade-XXXXXXXX`
- タイトル: `[Snyk] Upgrade <package> from X.X.X to Y.Y.Y`
- 変更ファイル: `package.json`, `package-lock.json`

### Snyk PR特有の注意点

1. **複数バージョンスキップ**: 多くのバージョンを一度にスキップする場合、累積したBreaking Changesに注意
2. **セキュリティ修正**: 脆弱性修正が目的の場合、優先度を上げて対応
3. **自動マージ**: CIが全パスしても、手動での動作確認を推奨

---

## 参考リンク

- [npm公式ドキュメント](https://docs.npmjs.com/)
- [Semantic Versioning](https://semver.org/lang/ja/)
- [Snyk Documentation](https://docs.snyk.io/)
